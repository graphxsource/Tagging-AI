name: Deploy to VPS Tagging AI

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USERNAME }} 
            key: ${{ secrets.VPS_SSH_KEY }}
            port: ${{ secrets.VPS_PORT }}
            script: |
                set -ex  # Enable debugging and exit on error

                # Debugging info
                echo "Current user: $(whoami)"
                echo "Working directory: $(pwd)"
                echo "Contents of /home/hndev/repos:"
                ls -la /home/hndev/repos

                # Navigate to project directory
                if ! cd /home/hndev/repos/Tagging-AI; then
                    echo "âŒ Error: Could not access /home/hndev/repos/Tagging-AI"
                    echo "Creating directory if it doesn't exist..."
                    mkdir -p /home/hndev/repos/Tagging-AI
                    cd /home/hndev/repos/Tagging-AI
                fi

                echo "ğŸ”„ Pulling latest 'main' branch..."
                git fetch origin main
                git reset --hard origin/main
                git clean -fd  # Remove untracked files

                echo "ğŸ”¨ Building Docker container..."
                if ! docker compose build --no-cache taggingai; then
                    echo "âŒ Build failed, please check the logs."
                    exit 1
                fi

                echo "ğŸ›‘ Stopping current container..."
                docker compose stop taggingai || true

                echo "ğŸ§¼ Removing old container..."
                docker compose rm -f taggingai || true

                echo "ğŸ§¹ Cleaning up Docker resources..."
                docker container prune -f
                docker image prune -af || true

                echo "ğŸš€ Starting new container..."
                docker compose up -d taggingai

                echo "âœ… Deployment complete!"
                echo "ğŸ”„ Checking container status..."
                docker compose ps